<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">

    <title>Waggle</title>

    <link th:href="@{/css/bootstrap.min.css}" href="../../../static/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css" rel="stylesheet">


    <style>
        a {
            color: inherit;
            text-decoration: none;
        }

        #calendar {
            max-width: 900px;
            margin: 0 auto;
        }

        #eventUpdateModal, #eventCreateModal {
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 700px;
            height: 500px;
        }

        .modal-header {
        }

        .modal-body {
            justify-content: center;
            padding: 0;
        }

        .form-group {
            margin-top: 8px;
        }

        .form-group label {
            display: inline-block;
            width: 80px;
            margin-right: 10px;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: calc(100% - 90px);
        }

        .form-group.input {
            display: flex;
            align-items: center;
            margin-top: 15px;
            width: 100%;
        }

        .form-group.input label {
            width: 80px;
            font-weight: bold;
        }

        .form-group.input input,
        .form-group.input textarea {
            flex: 1;
        }

        .fc-day:hover {
            background-color: lightgray;
            cursor: pointer;
        }

    </style>
</head>
<body>

<th:block th:replace="fragments/header.html :: fragment-header"></th:block>
<div id="calendar"></div>
<div id="eventUpdateModal">
    <div class="modal-content">
        <form id="eventUpdateForm" th:action="@{/schedule/update}" method="post">
            <input type="hidden" id="updateId" name="id">

            <div class="modal-body">
                <div class="form-group input">
                    <input class="form-control" type="text" id="updateTitle" name="title"
                           style="font-weight: bold; font-size: 20px; text-decoration: none">
                </div>
                <div class="form-group input">
                    <label for="updateScheduleTime">날짜</label>
                    <input class="form-control" type="datetime-local" id="updateScheduleTime" name="scheduleTime">
                </div>
                <div class="form-group input">
                    <label for="updateScheduleMembers">담당자</label>
                    <input class="form-control" type="text" id="updateScheduleMembers" name="scheduleMembers">
                </div>
                <div class="form-group input">
                    <textarea class="form-control" id="updateDescription" name="description"
                              style="height: 250px; margin-top: 20px;"></textarea>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="eventCreateModal">
    <div class="modal-content">
        <form id="eventCreateForm" th:action="@{/schedule/create}" method="post">
            <input type="hidden" id="createId" name="id">

            <div class="modal-body">
                <div class="form-group input">
                    <input class="form-control" type="text" id="createTitle" name="title"
                           style="font-weight: bold; font-size: 20px; text-decoration: none">
                </div>
                <div class="form-group input">
                    <label for="updateScheduleTime">날짜</label>
                    <input class="form-control" type="datetime-local" id="createScheduleTime" name="scheduleTime">
                </div>
                <div class="form-group input">
                    <label for="updateScheduleMembers">담당자</label>
                    <input class="form-control" type="text" id="createScheduleMembers" name="scheduleMembers">
                </div>
                <div class="form-group input">
                    <textarea class="form-control" id="createDescription" name="description"
                              style="height: 250px; margin-top: 20px;"></textarea>
                </div>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    var schedules = /*[[${scheduleDtos}]]*/ [];
    var updatedEvent = null;

    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var updateModal = document.getElementById("eventUpdateModal");
        var createModal = document.getElementById("eventCreateModal");
        var calendar = new FullCalendar.Calendar(calendarEl, {
            // FullCalendar 설정 옵션들
            initialView: 'dayGridMonth',
            events: schedules.map(function (schedule) {
                return {
                    id: schedule.id,
                    title: schedule.title,
                    start: schedule.scheduleTime,
                    description: schedule.description,
                    scheduleMembers: schedule.scheduleMembers,
                };
            }),
            dateClick: function (info) {

                // var form = document.getElementById("eventCreateForm");
                // form.elements["createId"].value = "";  // 새로운 일정의 경우 ID를 비웁니다.
                // form.elements["createTitle"].value = "";
                // form.elements["createScheduleTime"].value = moment(info.date).format('YYYY-MM-DDTHH:mm');
                // form.elements["createDescription"].value = "";
                // form.elements["createScheduleMembers"].value = "";
                document.getElementById('createId').value = "";
                document.getElementById('createTitle').value = "";
                document.getElementById('createScheduleTime').value = moment(info.date).format('YYYY-MM-DDTHH:mm');
                document.getElementById('createDescription').value = "";
                document.getElementById('createScheduleMembers').value = "";

                createModal.style.display = "block";
            },
            eventClick: function (info) {
                var event = info.event;
                document.getElementById('updateId').value = event.id;
                document.getElementById('updateTitle').value = event.title;
                document.getElementById('updateScheduleTime').value = moment(event.start).format('YYYY-MM-DDTHH:mm');
                document.getElementById('updateDescription').value = event.description;
                document.getElementById('updateScheduleMembers').value = event.scheduleMembers;
                updatedEvent = event;

                updateModal.style.display = "block";
            }
        });

        calendar.render();
    });

    window.addEventListener('click', function (event) {
        var updateModal = document.getElementById("eventUpdateModal");
        var createModal = document.getElementById("eventCreateModal");

        if (event.target === updateModal) {
            var form = document.getElementById("eventUpdateForm");
            if (updatedEvent) {
                form.elements["id"].value = updatedEvent.id;
                form.elements["title"].value = document.getElementById('updateTitle').value;
                form.elements["scheduleTime"].value = document.getElementById('updateScheduleTime').value;
                form.elements["description"].value = document.getElementById('updateDescription').value;
                form.elements["scheduleMembers"].value = document.getElementById('updateScheduleMembers').value;

                form.submit();
            }
            updatedEvent = null;
            updateModal.style.display = "none";
        }

        if (event.target === createModal) {
            var form = document.getElementById("eventCreateForm");
            form.elements["title"].value = document.getElementById('createTitle').value;
            form.elements["scheduleTime"].value = document.getElementById('createScheduleTime').value;
            form.elements["description"].value = document.getElementById('createDescription').value;
            form.elements["scheduleMembers"].value = document.getElementById('createScheduleMembers').value;

            form.submit();

            createModal.style.display = "none";
        }

    });


</script>
</body>
</html>